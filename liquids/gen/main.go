package main

import (
	"encoding/json"
	"fmt"
	"os"
	"path/filepath"
	"sort"
	"strconv"
	"strings"
)

type point struct {
	Pr   float64 `json:"p_r"`
	RhoR float64 `json:"rho_r"`
}

func main() {
	// 1. Find paths
	// When running via go generate in liquids/, CWD is liquids/
	cwd, err := os.Getwd()
	if err != nil {
		panic(err)
	}

	jsonPath := filepath.Join(cwd, "..", "data", "lydersen_normal.json")
	outPath := filepath.Join(cwd, "lydersen_table.go")

	fmt.Printf("Reading from: %s\n", jsonPath)

	// 2. Read JSON
	data, err := os.ReadFile(jsonPath)
	if err != nil {
		panic(fmt.Sprintf("Failed to read %s: %v", jsonPath, err))
	}

	var rawMap map[string][]point
	if err := json.Unmarshal(data, &rawMap); err != nil {
		panic(err)
	}

	// 3. Process Data
	var satPoints []point
	type IsoTemp struct {
		Tr     float64
		Points []point
	}
	var isotherms []IsoTemp

	for k, v := range rawMap {
		if k == "-1" {
			satPoints = v
			continue
		}
		tr, err := strconv.ParseFloat(k, 64)
		if err != nil {
			panic(fmt.Sprintf("Failed to parse Tr key '%s': %v", k, err))
		}
		isotherms = append(isotherms, IsoTemp{Tr: tr, Points: v})
	}

	// Sort isotherms by Tr
	sort.Slice(isotherms, func(i, j int) bool {
		return isotherms[i].Tr < isotherms[j].Tr
	})

	// 4. Generate Code
	var sb strings.Builder
	sb.WriteString("// Code generated by gen/main.go; DO NOT EDIT.\n\n")
	sb.WriteString("package liquids\n\n")
	sb.WriteString("var lydersenData = LydersenTable{\n")

	// Saturation
	sb.WriteString("\tSaturation: []point{\n")
	for _, p := range satPoints {
		fmt.Fprintf(&sb, "\t\t{Pr: %g, RhoR: %g},\n", p.Pr, p.RhoR)
	}
	sb.WriteString("\t},\n")

	// Isotherms
	sb.WriteString("\tIsotherms: []isotherm{\n")
	for _, iso := range isotherms {
		fmt.Fprintf(&sb, "\t\t{Tr: %g, Points: []point{\n", iso.Tr)
		for _, p := range iso.Points {
			fmt.Fprintf(&sb, "\t\t\t{Pr: %g, RhoR: %g},\n", p.Pr, p.RhoR)
		}
		sb.WriteString("\t\t}},\n")
	}
	sb.WriteString("\t},\n")
	sb.WriteString("}\n")

	// 5. Write file
	if err := os.WriteFile(outPath, []byte(sb.String()), 0644); err != nil {
		panic(err)
	}
	fmt.Printf("Generated %s\n", outPath)
}
