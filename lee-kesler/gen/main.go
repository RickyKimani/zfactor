package main

import (
	"encoding/json"
	"fmt"
	"log"
	"os"
	"strings"
)

type table struct {
	Pr     []float64   `json:"reduced_pressure"`
	Tr     []float64   `json:"reduced_temperature"`
	Values [][]float64 `json:"values"`
}

func main() {
	jsonFile := "../data/lee_kesler.json"
	outputFile := "tables.go"

	data, err := os.ReadFile(jsonFile)
	if err != nil {
		log.Fatal(err)
	}

	var tables map[string][]table
	err = json.Unmarshal(data, &tables)
	if err != nil {
		log.Fatal(err)
	}

	structCode := `// table represents a Lee/Kesler generalized correlation table
type table struct {
    Pr     []float64   //Reduced Pressure (x-axis)
    Tr     []float64   //Reduced Temperature (y-axis)
    Values [][]float64 //Values => f(Pr[i], Tr[j])
}
`

	goCode := `// Code generated by go generate; DO NOT EDIT.

// package leekesler contains the Lee/Kelser generalized correlation 
// tables for the compressibility factor, residual enthalpy, 
// residual entropy and the fugacity coefficient.
package leekesler

// Lee-Kesler generalized correlation tables
// Generated from parsed PDF tables

` + structCode

	var count int
	fmt.Println("#------------------------------------------------------#")

	for key, tableList := range tables {
		if len(tableList) == 0 {
			continue
		}
		// Expect exactly one combined table per key. If multiple exist, take the first.
		t := tableList[0]
		varName := strings.ToUpper(key) + "Table"
		fmt.Printf("Processing %s table\n", varName)
		goCode += fmt.Sprintf("var %s = table{\n", varName)
		goCode += fmt.Sprintf("\tPr: []float64{%s},\n", floatsToString(t.Pr))
		goCode += fmt.Sprintf("\tTr: []float64{%s},\n", floatsToString(t.Tr))
		goCode += "\tValues: [][]float64{\n"
		for _, row := range t.Values {
			goCode += fmt.Sprintf("\t\t{%s},\n", floatsToString(row))
		}
		goCode += "\t},\n"
		goCode += "}\n\n"
		count++
	}

	fmt.Printf("Processed %d Lee/Kesler tables\n", count)
	fmt.Println("#------------------------------------------------------#")

	err = os.WriteFile(outputFile, []byte(goCode), 0644)
	if err != nil {
		log.Fatal(err)
	}
}

func floatsToString(fs []float64) string {
	strs := make([]string, len(fs))
	for i, f := range fs {
		strs[i] = fmt.Sprintf("%.4f", f)
	}
	return strings.Join(strs, ", ")
}
